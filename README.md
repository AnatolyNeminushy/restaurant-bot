# Ayami Telegram Bot

Телеграм-бот сети суши-баров, который помогает гостям оформить заказ, забронировать стол, связаться с оператором и получать статистику через REST API.

## Возможности

- Интерактивное меню с категориями, описаниями и корзиной.
- Пошаговый мастер заказа (доставка/самовывоз, время, оплата, комментарии).
- Процесс бронирования столика с проверкой ограничений.
- Передача чата оператору и логирование сообщений в PostgreSQL.
- REST эндпойнты для просмотра чатов, сообщений и статистики по заказам и броням.
- Интеграция с OpenAI API для подсказок оператору (опционально).

## Стек

- Node.js (CommonJS), Telegraf, Express, cors.
- PostgreSQL + node-postgres (pg) с SSL.
- Day.js (timezone + customParseFormat), csv-parser, luxon.
- prom-client для будущего мониторинга.

## Структура проекта

`
assets/         статические файлы (svg, csv, инструкция)
data/           CSV/JSON представления меню, карта категорий
handlers/       обработчики команд и action-ов Telegraf
middlewares/    сложные сценарии (оформление заказа, резерв, оператор)
order_cart/     логика корзины и расчёт сумм
server/         подключение к базе, вспомогательные скрипты
utils/          клавиатуры, политики и прочие утилиты
index.js        точка входа: Express API + запуск бота
.env.example    шаблон переменных окружения
`

## Требования

- Docker 20+ и Docker Compose V2 (рекомендуемый способ запуска).
- Либо Node.js 18+ и доступный PostgreSQL 13+ (если хотите запустить без контейнеров).
- Токен Telegram-бота и, при необходимости, OpenAI API ключ.

## Как получить токен Telegram

1. Откройте приложение Telegram и найдите бота @BotFather.
2. Нажмите «Start» и выполните команду /newbot.
3. Придумайте название бота (видно пользователям) и уникальный username, который заканчивается на bot (например, cool_demo_bot).
4. BotFather выдаст HTTP API token. Скопируйте его в .env в поле BOT_TOKEN.
5. Храните токен в секрете. Если он утёк, выполните /token → «Revoke current token» в BotFather и обновите значение в .env.

## Быстрый старт (Docker)

1. Скопируйте переменные окружения и заполните реальные значения:
   `bash
   cp .env.example .env
   # укажите токены и настройки, для docker-compose обязательно PGHOST=db, PGSSLMODE=disable
   `
2. Запустите контейнеры:
   `bash
   docker compose up --build
   `
3. API бота будет доступно по http://localhost:5000, PostgreSQL проброшен на localhost:5432.
4. Данные базы хранятся в volume db_data. Остановить и удалить контейнеры можно командой docker compose down (с флагом -v, если нужно очистить volume).

## Локальный запуск без Docker (опционально)

1. Убедитесь, что установлен Node.js 18+ и работает PostgreSQL.
2. Установите зависимости и заполните .env:
   `bash
   npm install
   cp .env.example .env
   # пропишите реальные значения, PGHOST=localhost и нужный PGSSLMODE
   `
3. Запустите бота:
   `bash
   node index.js
   # или с авто-перезапуском: npx nodemon index.js
   `

## Переменные окружения

| Ключ                  | Назначение                                                        |
|-----------------------|-------------------------------------------------------------------|
| BOT_TOKEN           | Telegram Bot API токен                                            |
| AI_API_KEY          | OpenAI API ключ (опционально)                                     |
| TG_GROUP_ORDERS_ID  | ID группы для уведомлений о заказах                               |
| TG_GROUP_RESERVES_ID| ID группы для уведомлений о резервах                              |
| GROUP_ORDER_APPL    | Внутренний чат для распределения заказов                          |
| GROUP_ORDER_RES     | Внутренний чат для уведомлений о резервах                         |
| FEEDBACK_GROUP      | Чат для отзывов                                                   |
| PGHOST              | Хост PostgreSQL (например, db в docker-compose или localhost) |
| PGPORT              | Порт PostgreSQL                                                   |
| PGDATABASE          | Имя базы данных                                                   |
| PGUSER              | Пользователь                                                      |
| PGPASSWORD          | Пароль                                                            |
| PGSSLMODE           | Режим SSL (disable, 
equire, verify-full)                   |
| PGSSL_CA_PATH       | Путь до корневого сертификата (если нужен)                        |

## REST API

| Метод | Путь                    | Описание                              |
|-------|-------------------------|---------------------------------------|
| GET   | /api/chats            | Список чатов                          |
| GET   | /api/messages?chatId= | Сообщения конкретного чата            |
| GET   | /api/stat/orders      | Количество заказов                    |
| GET   | /api/stat/orders-sum  | Общая сумма заказов                   |
| GET   | /api/stat/orders-by-day       | Аггрегированная статистика по датам |
| GET   | /api/stat/orders-by-created   | Статистика по created_at          |
| GET   | /api/stat/orders-extra        | Средний чек и максимумы             |
| GET   | /api/stat/reserves            | Количество броней                   |

Все эндпойнты возвращают JSON, при ошибках вернётся 503 с сообщением Temporary server error.

## Команды Telegram

- /start — приветствие, ссылки на меню, оператора и бронь.
- /cart — показать текущее содержимое корзины.
- /operator — соединить пользователя с оператором.
- Inline-кнопки категорий, доставки, времени, оплаты и т.д.

## Работа с БД

Основные таблицы: chats, messages, orders, 
eservations, order_items. Подключайте бота к своей PostgreSQL — локальной, контейнерной или облачной. Схему/данные можно накатить отдельными миграциями или дампом, которые хранятся вне репозитория.

Меню подгружается из assets/menu.csv и кэшируется при старте.

## Мониторинг и логирование

- Логирование ошибок Express и Telegraf в консоль.
- Сохранение чатов и сообщений в PostgreSQL для аналитики.
- prom-client подготовлен для экспорта метрик (нужно подключить вручную).

## Безопасность

1. Не коммитьте .env и реальные ключи.
2. Замените все токены и пароли, которые уже попали в историю.
3. Настройте SSL режим и храните сертификаты вне репозитория, если возможно.

## Идеи для развития

- Написать тесты для корзины и пошаговых сценариев.
- Оформить миграции базы данных.
- Настроить CI/CD с проверками, сборкой Docker-образа и деплоем.
- Подключить сбор метрик и дашборды.


